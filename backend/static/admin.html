<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxEase Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .controls label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .controls select, .controls input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }
        .btn:hover { background: #5568d3; }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .btn-warning { background: #ed8936; }
        .btn-warning:hover { background: #dd6b20; }
        .btn-danger { background: #f56565; }
        .btn-danger:hover { background: #e53e3e; }
        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        tr:hover { background: #f8f9fa; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
        }
        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .form-section.active {
            display: block;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 15px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ TaxEase Admin Panel</h1>
            <p>Manage tax slabs, allowances, deductions, and system settings (FY 2025-26)</p>
        </div>

        <div class="controls">
            <label>Select Resource Type:</label>
            <select id="resourceType" onchange="updateFilters()">
                <option value="tax-slabs">Tax Slabs</option>
                <option value="allowances">Allowances</option>
                <option value="deductions">Deductions</option>
                <option value="settings">System Settings</option>
            </select>

            <div id="filters">
                <label>Category (Optional):</label>
                <select id="category">
                    <option value="">All Categories</option>
                    <option value="salaried">Salaried</option>
                    <option value="business">Business</option>
                    <option value="freelancer">Freelancer</option>
                </select>

                <label>Tax Year (Optional):</label>
                <select id="taxYear">
                    <option value="">All Years</option>
                    <option value="2025-26" selected>2025-26</option>
                    <option value="2024-25">2024-25</option>
                </select>
            </div>

            <button class="btn" onclick="fetchData()">üîç Load Data</button>
            <button class="btn btn-success" onclick="showCreateForm()">‚ûï Create New</button>
        </div>

        <!-- Create Form -->
        <div id="createForm" class="form-section">
            <h3>Create New Resource</h3>
            <textarea id="createData" placeholder='Enter JSON data, e.g.:
{
  "category": "salaried",
  "tax_year": "2025-26",
  "min_income": 0,
  "max_income": 100000,
  "fixed_tax": 0,
  "tax_rate": 5,
  "description": "Test slab",
  "is_active": true
}'></textarea>
            <button class="btn btn-success" onclick="createResource()">Create</button>
            <button class="btn" onclick="hideCreateForm()">Cancel</button>
        </div>

        <div class="results">
            <h2 id="resultsTitle">Results</h2>
            <div id="resultsContent">
                <p style="color: #999; text-align: center; padding: 40px;">
                    Select options and click "Load Data"
                </p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/admin';

        function updateFilters() {
            const resource = document.getElementById('resourceType').value;
            const filtersDiv = document.getElementById('filters');
            
            // Hide filters for settings
            if (resource === 'settings') {
                filtersDiv.style.display = 'none';
            } else {
                filtersDiv.style.display = 'block';
            }
        }

        async function fetchData() {
            const resource = document.getElementById('resourceType').value;
            const category = document.getElementById('category').value;
            const taxYear = document.getElementById('taxYear').value;

            let url = `${API_BASE}?resource=${resource}`;
            if (category) url += `&category=${category}`;
            if (taxYear && resource === 'tax-slabs') url += `&tax_year=${taxYear}`;

            document.getElementById('resultsContent').innerHTML = '<p style="text-align: center;">Loading...</p>';

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    throw new Error(data.detail || 'Failed to fetch data');
                }
            } catch (error) {
                document.getElementById('resultsContent').innerHTML = 
                    `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayResults(data) {
            const title = document.getElementById('resultsTitle');
            const content = document.getElementById('resultsContent');

            title.textContent = `${data.resource_type.replace('_', ' ').toUpperCase()} (${data.total} records)`;

            if (data.total === 0) {
                content.innerHTML = '<p style="color: #999;">No records found</p>';
                return;
            }

            let html = '';

            if (data.resource_type === 'tax_slabs') {
                html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Income Range</th>
                                <th>Fixed Tax</th>
                                <th>Rate</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(item => `
                                <tr>
                                    <td>${item.id}</td>
                                    <td>Rs. ${item.min_income.toLocaleString()} - ${item.max_income ? 'Rs. ' + item.max_income.toLocaleString() : 'No Limit'}</td>
                                    <td>Rs. ${item.fixed_tax.toLocaleString()}</td>
                                    <td>${item.tax_rate}%</td>
                                    <td>${item.description}</td>
                                    <td><span class="badge">${item.is_active ? 'Active' : 'Inactive'}</span></td>
                                    <td>
                                        <button class="action-btn btn-warning" onclick='updateResource(${item.id}, ${JSON.stringify(item)})'>Edit</button>
                                        <button class="action-btn btn-danger" onclick="deleteResource(${item.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (data.resource_type === 'allowances') {
                html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Exempt %</th>
                                <th>Max Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(item => `
                                <tr>
                                    <td>${item.id}</td>
                                    <td><strong>${item.name}</strong></td>
                                    <td>${item.exempt_percentage}%</td>
                                    <td>${item.max_exempt_amount ? 'Rs. ' + item.max_exempt_amount.toLocaleString() : 'No Limit'}</td>
                                    <td>${item.description}</td>
                                    <td>
                                        <button class="action-btn btn-warning" onclick='updateResource(${item.id}, ${JSON.stringify(item)})'>Edit</button>
                                        <button class="action-btn btn-danger" onclick="deleteResource(${item.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (data.resource_type === 'deductions') {
                html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Max %</th>
                                <th>Max Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(item => `
                                <tr>
                                    <td>${item.id}</td>
                                    <td><strong>${item.name}</strong></td>
                                    <td>${item.max_deduction_percentage || 'N/A'}%</td>
                                    <td>${item.max_deduction_amount ? 'Rs. ' + item.max_deduction_amount.toLocaleString() : 'No Limit'}</td>
                                    <td>${item.description}</td>
                                    <td>
                                        <button class="action-btn btn-warning" onclick='updateResource(${item.id}, ${JSON.stringify(item)})'>Edit</button>
                                        <button class="action-btn btn-danger" onclick="deleteResource(${item.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (data.resource_type === 'settings') {
                html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Value</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(item => `
                                <tr>
                                    <td><strong>${item.setting_key}</strong></td>
                                    <td><span class="badge">${item.setting_value}</span></td>
                                    <td>${item.setting_type}</td>
                                    <td>${item.description}</td>
                                    <td>
                                        <button class="action-btn btn-warning" onclick='updateSetting("${item.setting_key}", ${JSON.stringify(item)})'>Edit</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            content.innerHTML = html;
        }

        function showCreateForm() {
            document.getElementById('createForm').classList.add('active');
            document.getElementById('createData').value = '';
        }

        function hideCreateForm() {
            document.getElementById('createForm').classList.remove('active');
        }

        async function createResource() {
            const resource = document.getElementById('resourceType').value;
            const dataText = document.getElementById('createData').value;

            try {
                const data = JSON.parse(dataText);
                
                const response = await fetch(`${API_BASE}?resource=${resource}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    hideCreateForm();
                    fetchData();
                } else {
                    throw new Error(result.detail || 'Failed to create');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function updateResource(id, currentData) {
            const resource = document.getElementById('resourceType').value;
            const newData = prompt('Enter updated JSON data:', JSON.stringify(currentData, null, 2));
            
            if (!newData) return;

            try {
                const data = JSON.parse(newData);
                
                const response = await fetch(`${API_BASE}?resource=${resource}&resource_id=${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    fetchData();
                } else {
                    throw new Error(result.detail || 'Failed to update');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function updateSetting(key, currentData) {
            const newData = prompt('Enter updated JSON data:', JSON.stringify(currentData, null, 2));
            
            if (!newData) return;

            try {
                const data = JSON.parse(newData);
                
                const response = await fetch(`${API_BASE}?resource=settings&key=${key}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    fetchData();
                } else {
                    throw new Error(result.detail || 'Failed to update');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteResource(id) {
            const resource = document.getElementById('resourceType').value;
            
            if (!confirm(`Are you sure you want to delete this ${resource}?`)) return;

            try {
                const response = await fetch(`${API_BASE}?resource=${resource}&resource_id=${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + result.message);
                    fetchData();
                } else {
                    throw new Error(result.detail || 'Failed to delete');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Load data on page load
        window.onload = () => {
            updateFilters();
            fetchData();
        };
    </script>
</body>
</html>